{% extends "base.html" %}

{% block title %}Cargar Datos - Torneo de P√°del{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-5 fw-bold">
                <i class="bi bi-database"></i> Cargar Datos de Parejas
            </h1>
        </div>
    </div>

    <!-- Tabs de Carga -->
    <div class="row mb-4">
        <div class="col">
            <ul class="nav nav-pills nav-fill shadow-sm" id="cargaTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="csv-tab" data-bs-toggle="pill" data-bs-target="#csv" type="button">
                        <i class="bi bi-file-earmark-spreadsheet"></i> Cargar CSV
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="manual-tab" data-bs-toggle="pill" data-bs-target="#manual" type="button">
                        <i class="bi bi-pencil-square"></i> Entrada Manual
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Contenido de Tabs -->
    <div class="tab-content" id="cargaTabsContent">
        <!-- Tab CSV -->
        <div class="tab-pane fade show active" id="csv" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Instrucciones:</strong> Carga un archivo CSV con las respuestas del formulario
                    </div>
                    
                    <form id="formCargarCSV" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="archivoCSV" class="form-label fw-bold">
                                Seleccionar archivo CSV
                            </label>
                            <input type="file" class="form-control form-control-lg" id="archivoCSV" name="archivo" accept=".csv" required>
                            <div class="form-text">El archivo debe tener columnas: Nombre, Tel√©fono, Categor√≠a y franjas horarias</div>
                        </div>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-upload"></i> Cargar Datos
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Tab Manual -->
        <div class="tab-pane fade" id="manual" role="tabpanel">
            <div class="card shadow-sm">
                <div class="card-body p-4">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Instrucciones:</strong> Ingresa los datos de cada pareja individualmente
                    </div>
                    
                    <form id="formAgregarPareja">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="nombre" class="form-label fw-bold">Nombre de la pareja *</label>
                                <input type="text" class="form-control" id="nombre" name="nombre" 
                                       placeholder="Ej: Juan P√©rez / Mar√≠a L√≥pez" required>
                            </div>
                            <div class="col-md-6">
                                <label for="telefono" class="form-label fw-bold">Tel√©fono</label>
                                <input type="text" class="form-control" id="telefono" name="telefono" 
                                       placeholder="Ej: 099123456">
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="categoria" class="form-label fw-bold">Categor√≠a *</label>
                                <select class="form-select" id="categoria" name="categoria" required>
                                    {% for cat in categorias %}
                                    <option value="{{ cat }}">{{ cat }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">Franjas horarias disponibles *</label>
                            <div class="form-text mb-2">Selecciona todas las franjas en las que pueden jugar</div>
                            <div class="row g-2">
                                {% for franja in franjas %}
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="franjas" 
                                               value="{{ franja }}" id="franja{{ loop.index }}">
                                        <label class="form-check-label" for="franja{{ loop.index }}">
                                            {{ franja }}
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="bi bi-plus-circle"></i> Agregar Pareja
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Secci√≥n de Datos Cargados -->
    {% if parejas %}
    <div class="row mt-5">
        <div class="col">
            <h2 class="h3 fw-bold mb-4">
                <i class="bi bi-bar-chart"></i> Resumen de Datos
            </h2>
        </div>
    </div>

    <!-- Estad√≠sticas -->
    <div class="row g-3 mb-4">
        <div class="col-md-2">
            <div class="card text-center shadow-sm stat-card cursor-pointer" onclick="filtrarPorCategoria(null)" style="cursor: pointer;">
                <div class="card-body">
                    <h3 class="display-6 fw-bold text-primary">{{ stats.total }}</h3>
                    <p class="text-muted mb-0">Total Parejas</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm stat-card stat-cuarta" onclick="filtrarPorCategoria('Cuarta')" style="cursor: pointer; transition: all 0.2s;" 
                 onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body">
                    <h3 class="display-6 fw-bold">{{ stats.por_categoria.Cuarta }}</h3>
                    <p class="mb-0">üü¢ Cuarta</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm stat-card stat-quinta" onclick="filtrarPorCategoria('Quinta')" style="cursor: pointer; transition: all 0.2s;"
                 onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body">
                    <h3 class="display-6 fw-bold">{{ stats.por_categoria.Quinta }}</h3>
                    <p class="mb-0">üü° Quinta</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm stat-card stat-sexta" onclick="filtrarPorCategoria('Sexta')" style="cursor: pointer; transition: all 0.2s;"
                 onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body">
                    <h3 class="display-6 fw-bold">{{ stats.por_categoria.Sexta }}</h3>
                    <p class="mb-0">üîµ Sexta</p>
                </div>
            </div>
        </div>
        <div class="col-md-2">
            <div class="card text-center shadow-sm stat-card stat-septima" onclick="filtrarPorCategoria('S√©ptima')" style="cursor: pointer; transition: all 0.2s;"
                 onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                <div class="card-body">
                    <h3 class="display-6 fw-bold">{{ stats.por_categoria['S√©ptima'] }}</h3>
                    <p class="mb-0">üü£ S√©ptima</p>
                </div>
            </div>
        </div>
        <div class="col-md-2 d-flex align-items-stretch">
            <button class="btn btn-outline-danger w-100" onclick="limpiarDatos()">
                <i class="bi bi-trash"></i> Limpiar
            </button>
        </div>
    </div>

    <!-- Leyenda de Estados -->
    {% if resultado %}
    <div class="row mb-3">
        <div class="col">
            <div class="alert alert-light border d-flex align-items-center justify-content-center" role="alert">
                <div class="d-flex gap-4 flex-wrap">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>
                        <span><strong>Rojo:</strong> Sin grupo asignado</span>
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="bi bi-exclamation-circle-fill text-warning me-2"></i>
                        <span><strong>Amarillo:</strong> Fuera de horario preferido</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Tabla de Parejas -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0" id="headerTablaParejas">
                <i class="bi bi-list-ul"></i> Listado de Parejas ({{ parejas|length }})
                {% if resultado %}
                {% set sin_asignar = parejas|selectattr('esta_asignada', 'equalto', False)|list|length %}
                {% set fuera_horario = parejas|selectattr('fuera_de_horario', 'equalto', True)|list|length %}
                {% if sin_asignar > 0 %}
                <span class="badge bg-danger ms-2">{{ sin_asignar }} sin grupo</span>
                {% endif %}
                {% if fuera_horario > 0 %}
                <span class="badge bg-warning text-dark ms-2">{{ fuera_horario }} fuera de horario</span>
                {% endif %}
                {% endif %}
            </h5>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive" style="max-height: 400px;">
                <table class="table table-hover mb-0">
                    <thead class="table-light sticky-top">
                        <tr>
                            <th width="5%">#</th>
                            <th width="30%">Nombre</th>
                            <th width="15%">Tel√©fono</th>
                            <th width="15%">Categor√≠a</th>
                            <th width="30%">Horarios Disponibles</th>
                            <th width="5%">Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="tablaParejas">
                        {% for pareja in parejas %}
                        {% set clase_estado = '' %}
                        {% set icono_estado = '' %}
                        {% if not pareja.esta_asignada %}
                            {% set clase_estado = 'pareja-sin-asignar' %}
                            {% set icono_estado = '<i class="bi bi-exclamation-triangle-fill text-danger me-2" title="Sin grupo asignado"></i>' %}
                        {% elif pareja.fuera_de_horario %}
                            {% set clase_estado = 'pareja-fuera-horario' %}
                            {% set icono_estado = '<i class="bi bi-exclamation-circle-fill text-warning me-2" title="Fuera de horario preferido"></i>' %}
                        {% endif %}
                        <tr data-id="{{ pareja.id }}" data-categoria="{{ pareja.categoria }}" class="{{ clase_estado }}">
                            <td>{{ loop.index }}</td>
                            <td class="fw-bold">{{ icono_estado|safe }}{{ pareja.nombre }}</td>
                            <td><i class="bi bi-telephone"></i> {{ pareja.telefono }}</td>
                            <td><span class="badge bg-secondary">{{ pareja.categoria }}</span></td>
                            <td><small>{{ ', '.join(pareja.franjas_disponibles) or 'Sin especificar' }}</small></td>
                            <td>
                                <button class="btn btn-sm btn-primary me-1" 
                                        data-pareja-id="{{ pareja.id }}"
                                        data-pareja-nombre="{{ pareja.nombre }}"
                                        data-pareja-telefono="{{ pareja.telefono }}"
                                        data-pareja-categoria="{{ pareja.categoria }}"
                                        data-pareja-franjas='{{ pareja.franjas_disponibles|tojson }}'
                                        onclick="editarParejaTabla(this)"
                                        title="Editar">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarPareja({{ pareja.id }})">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Bot√≥n Ejecutar Algoritmo -->
    <div class="row">
        <div class="col text-center">
            <button id="btnEjecutarAlgoritmo" class="btn btn-success btn-lg px-5 py-3 shadow-lg" onclick="ejecutarAlgoritmo()">
                <i class="bi bi-cpu"></i> EJECUTAR ALGORITMO
            </button>
        </div>
    </div>
    {% endif %}
</div>

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center p-5">
                <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Cargando...</span>
                </div>
                <h5>Generando grupos √≥ptimos...</h5>
                <p class="text-muted">Por favor espera un momento</p>
            </div>
        </div>
    </div>
</div>

<!-- Modal Editar Pareja -->
<div class="modal fade" id="modalEditarParejaTabla" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="bi bi-pencil-square"></i> Editar Pareja
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editParejaId">
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Nombre de la Pareja</label>
                    <input type="text" class="form-control" id="editPanejaNombre" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Tel√©fono</label>
                    <input type="text" class="form-control" id="editParejaTelefono">
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Categor√≠a</label>
                    <select class="form-select" id="editParejaCategoria" required>
                        <option value="Cuarta">Cuarta</option>
                        <option value="Quinta">Quinta</option>
                        <option value="Sexta">Sexta</option>
                        <option value="S√©ptima">S√©ptima</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label class="form-label fw-bold">Franjas Horarias Disponibles</label>
                    <div class="row g-2">
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaJ18" value="Jueves 18:00">
                                <label class="form-check-label" for="editFranjaJ18">Jueves 18:00</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaJ20" value="Jueves 20:00">
                                <label class="form-check-label" for="editFranjaJ20">Jueves 20:00</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaJ22" value="Jueves 22:00">
                                <label class="form-check-label" for="editFranjaJ22">Jueves 22:00</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaJ0" value="Jueves 00:00">
                                <label class="form-check-label" for="editFranjaJ0">Jueves 00:00</label>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaS12" value="S√°bado 12:00">
                                <label class="form-check-label" for="editFranjaS12">S√°bado 12:00</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaS14" value="S√°bado 14:00">
                                <label class="form-check-label" for="editFranjaS14">S√°bado 14:00</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaS16" value="S√°bado 16:00">
                                <label class="form-check-label" for="editFranjaS16">S√°bado 16:00</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="editFranjaS18" value="S√°bado 18:00">
                                <label class="form-check-label" for="editFranjaS18">S√°bado 18:00</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="confirmarEditarParejaTabla()">
                    <i class="bi bi-check-lg"></i> Guardar Cambios
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Cargar CSV
$('#formCargarCSV').on('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const btnSubmit = $(this).find('button[type="submit"]');
    btnSubmit.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>Cargando...');
    
    $.ajax({
        url: '/api/cargar-csv',
        type: 'POST',
        data: formData,
        processData: false,
        contentType: false,
        success: function(response) {
            Toast.success(response.mensaje);
            
            // Si hay suficientes parejas, preguntar si desea ejecutar el algoritmo
            if (response.parejas && response.parejas.length >= 3) {
                setTimeout(() => {
                    if (confirm(`${response.parejas.length} parejas cargadas. ¬øDeseas generar los grupos autom√°ticamente ahora?`)) {
                        ejecutarAlgoritmoYRedirigir();
                    } else {
                        actualizarListaParejas();
                        btnSubmit.prop('disabled', false).html('<i class="bi bi-upload"></i> Cargar Datos');
                    }
                }, 500);
            } else {
                setTimeout(() => {
                    actualizarListaParejas();
                    btnSubmit.prop('disabled', false).html('<i class="bi bi-upload"></i> Cargar Datos');
                }, 800);
            }
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
            Toast.error('Error: ' + error);
            btnSubmit.prop('disabled', false).html('<i class="bi bi-upload"></i> Cargar Datos');
        }
    });
});

// Agregar pareja manual
$('#formAgregarPareja').on('submit', function(e) {
    e.preventDefault();
    
    const franjas = [];
    $('input[name="franjas"]:checked').each(function() {
        franjas.push($(this).val());
    });
    
    const data = {
        nombre: $('#nombre').val(),
        telefono: $('#telefono').val(),
        categoria: $('#categoria').val(),
        franjas: franjas
    };
    
    $.ajax({
        url: '/api/agregar-pareja',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(data),
        success: function(response) {
            Toast.success(response.mensaje);
            $('#formAgregarPareja')[0].reset();
            setTimeout(() => actualizarListaParejas(), 800);
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
            Toast.error('Error: ' + error);
        }
    });
});

// Eliminar pareja
function eliminarPareja(id) {
    $.ajax({
        url: '/api/eliminar-pareja/' + id,
        type: 'DELETE',
        success: function(response) {
            Toast.success('Pareja eliminada correctamente');
            setTimeout(() => actualizarListaParejas(), 500);
        },
        error: function() {
            Toast.error('Error al eliminar');
        }
    });
}

// Editar pareja desde tabla
function editarParejaTabla(button) {
    const id = button.getAttribute('data-pareja-id');
    const nombre = button.getAttribute('data-pareja-nombre');
    const telefono = button.getAttribute('data-pareja-telefono');
    const categoria = button.getAttribute('data-pareja-categoria');
    const franjas = JSON.parse(button.getAttribute('data-pareja-franjas'));
    
    document.getElementById('editParejaId').value = id;
    document.getElementById('editPanejaNombre').value = nombre;
    document.getElementById('editParejaTelefono').value = telefono;
    document.getElementById('editParejaCategoria').value = categoria;
    
    // Limpiar checkboxes
    document.querySelectorAll('#modalEditarParejaTabla input[type="checkbox"]').forEach(cb => cb.checked = false);
    
    // Marcar franjas actuales
    franjas.forEach(franja => {
        const checkbox = Array.from(document.querySelectorAll('#modalEditarParejaTabla input[type="checkbox"]'))
            .find(cb => cb.value === franja);
        if (checkbox) checkbox.checked = true;
    });
    
    const modal = new bootstrap.Modal(document.getElementById('modalEditarParejaTabla'));
    modal.show();
}

function confirmarEditarParejaTabla() {
    const id = document.getElementById('editParejaId').value;
    const nombre = document.getElementById('editPanejaNombre').value;
    const telefono = document.getElementById('editParejaTelefono').value;
    const categoria = document.getElementById('editParejaCategoria').value;
    
    const franjasChecked = [];
    document.querySelectorAll('#modalEditarParejaTabla input[type="checkbox"]:checked').forEach(cb => {
        franjasChecked.push(cb.value);
    });
    
    if (!nombre) {
        Toast.error('El nombre es requerido');
        return;
    }
    
    if (franjasChecked.length === 0) {
        Toast.error('Selecciona al menos una franja horaria');
        return;
    }
    
    $.ajax({
        url: '/api/editar-pareja',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            pareja_id: parseInt(id),
            nombre: nombre,
            telefono: telefono || 'Sin tel√©fono',
            categoria: categoria,
            franjas: franjasChecked
        }),
        success: function(response) {
            Toast.success(response.mensaje);
            const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarParejaTabla'));
            modal.hide();
            setTimeout(() => actualizarListaParejas(), 500);
        },
        error: function(xhr) {
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
            Toast.error('Error: ' + error);
        }
    });
}

// Limpiar datos
function limpiarDatos() {
    if (!confirm('¬øEst√°s seguro de que deseas eliminar todos los datos?')) {
        return;
    }
    
    $.ajax({
        url: '/api/limpiar-datos',
        type: 'POST',
        success: function(response) {
            Toast.success('Datos limpiados correctamente');
            // Esperar un momento y recargar p√°gina porque toda la UI cambia
            setTimeout(() => location.reload(), 800);
        },
        error: function() {
            Toast.error('Error al limpiar datos');
        }
    });
}

// Ejecutar algoritmo
function ejecutarAlgoritmo() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    $.ajax({
        url: '/api/ejecutar-algoritmo',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(response) {
            modal.hide();
            Toast.success(response.mensaje);
            setTimeout(() => window.location.href = '/resultados', 1000);
        },
        error: function(xhr) {
            modal.hide();
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
            Toast.error('Error: ' + error);
            console.error(xhr.responseJSON);
        }
    });
}

// Ejecutar algoritmo y redirigir (usado despu√©s de cargar CSV)
function ejecutarAlgoritmoYRedirigir() {
    const modal = new bootstrap.Modal(document.getElementById('loadingModal'));
    modal.show();
    
    $.ajax({
        url: '/api/ejecutar-algoritmo',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({}),
        success: function(response) {
            modal.hide();
            Toast.success('Grupos generados exitosamente');
            setTimeout(() => window.location.href = '/resultados', 500);
        },
        error: function(xhr) {
            modal.hide();
            const error = xhr.responseJSON ? xhr.responseJSON.error : 'Error desconocido';
            Toast.error('Error: ' + error);
            console.error(xhr.responseJSON);
            // Si falla, actualizar la lista normal
            actualizarListaParejas();
        }
    });
}

// Variable para mantener el estado del filtro actual
let categoriaFiltroActual = null;

// Filtrar tabla por categor√≠a
function filtrarPorCategoria(categoria) {
    const filas = document.querySelectorAll('#tablaParejas tr[data-categoria]');
    const cards = document.querySelectorAll('.stat-card');
    
    // Si se hace clic en la misma categor√≠a, quitar filtro
    if (categoriaFiltroActual === categoria) {
        categoria = null;
    }
    
    categoriaFiltroActual = categoria;
    
    // Remover efecto activo de todas las tarjetas
    cards.forEach(card => {
        card.style.boxShadow = '';
        card.style.border = '';
    });
    
    // Filtrar filas
    let filasMostradas = 0;
    filas.forEach(fila => {
        if (!categoria || fila.getAttribute('data-categoria') === categoria) {
            fila.style.display = '';
            filasMostradas++;
            // Actualizar n√∫mero de fila
            fila.querySelector('td:first-child').textContent = filasMostradas;
        } else {
            fila.style.display = 'none';
        }
    });
    
    // Resaltar tarjeta activa
    if (categoria) {
        const categoriaLower = categoria.toLowerCase();
        let cardActiva = null;
        
        if (categoriaLower === 'cuarta') {
            cardActiva = document.querySelector('.stat-cuarta');
        } else if (categoriaLower === 'quinta') {
            cardActiva = document.querySelector('.stat-quinta');
        } else if (categoriaLower === 'sexta') {
            cardActiva = document.querySelector('.stat-sexta');
        } else if (categoriaLower === 's√©ptima') {
            cardActiva = document.querySelector('.stat-septima');
        }
        
        if (cardActiva) {
            cardActiva.style.boxShadow = '0 0 15px rgba(13, 110, 253, 0.6)';
            cardActiva.style.border = '2px solid #0d6efd';
        }
    }
    
    // Actualizar contador en header de la tabla
    const header = document.querySelector('.card-header h5');
    if (categoria) {
        header.innerHTML = `<i class="bi bi-list-ul"></i> Listado de Parejas - ${categoria} (${filasMostradas})`;
    } else {
        header.innerHTML = `<i class="bi bi-list-ul"></i> Listado de Parejas ({{ parejas|length }})`;
    }
}

// ==========================================
// ACTUALIZACI√ìN SIN RECARGAR P√ÅGINA
// ==========================================

function actualizarListaParejas() {
    // Obtener datos actualizados desde el servidor
    $.ajax({
        url: '/api/obtener-parejas',
        type: 'GET',
        success: function(response) {
            if (response.success) {
                actualizarInterfaz(response.parejas, response.stats);
            }
        },
        error: function() {
            // Si falla, recargar la p√°gina como fallback
            location.reload();
        }
    });
}

function actualizarInterfaz(parejas, stats) {
    // Actualizar estad√≠sticas
    actualizarEstadisticas(stats);
    
    // Actualizar tabla de parejas
    actualizarTablaParejas(parejas);
    
    // Mostrar/ocultar secci√≥n de datos seg√∫n si hay parejas
    const seccionDatos = document.querySelector('.row.mt-5');
    const btnEjecutar = document.getElementById('btnEjecutarAlgoritmo');
    
    if (parejas.length > 0) {
        if (seccionDatos) seccionDatos.style.display = '';
        if (btnEjecutar) btnEjecutar.parentElement.parentElement.style.display = '';
    } else {
        location.reload(); // Si no hay parejas, recargar para mostrar vista limpia
    }
}

function actualizarEstadisticas(stats) {
    // Actualizar contador total
    const totalElement = document.querySelector('.stat-card:not(.stat-cuarta):not(.stat-quinta):not(.stat-sexta):not(.stat-septima) .display-6');
    if (totalElement) {
        totalElement.textContent = stats.total;
    }
    
    // Actualizar contadores por categor√≠a
    const categorias = {
        'Cuarta': '.stat-cuarta .display-6',
        'Quinta': '.stat-quinta .display-6',
        'Sexta': '.stat-sexta .display-6',
        'S√©ptima': '.stat-septima .display-6'
    };
    
    for (const [categoria, selector] of Object.entries(categorias)) {
        const element = document.querySelector(selector);
        if (element) {
            element.textContent = stats.por_categoria[categoria] || 0;
        }
    }
}

function actualizarTablaParejas(parejas) {
    const tbody = document.getElementById('tablaParejas');
    if (!tbody) return;
    
    // Limpiar tabla actual
    tbody.innerHTML = '';
    
    // Si no hay parejas, mostrar mensaje
    if (parejas.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted py-4">No hay parejas cargadas</td></tr>';
        return;
    }
    
    // Ordenar parejas por categor√≠a
    const ordenCategorias = ['Cuarta', 'Quinta', 'Sexta', 'S√©ptima'];
    const parejasOrdenadas = [...parejas].sort((a, b) => {
        const indexA = ordenCategorias.indexOf(a.categoria);
        const indexB = ordenCategorias.indexOf(b.categoria);
        return indexA - indexB;
    });
    
    // Agregar filas de parejas
    parejasOrdenadas.forEach((pareja, index) => {
        const fila = document.createElement('tr');
        fila.setAttribute('data-id', pareja.id);
        fila.setAttribute('data-categoria', pareja.categoria);
        
        // Determinar clases de estilo seg√∫n el estado
        let claseEstado = '';
        let iconoEstado = '';
        let tooltipEstado = '';
        
        if (!pareja.esta_asignada) {
            // Pareja NO asignada a ning√∫n grupo (ROJO)
            claseEstado = 'pareja-sin-asignar';
            iconoEstado = '<i class="bi bi-exclamation-triangle-fill text-danger me-2" title="Sin grupo asignado"></i>';
            tooltipEstado = 'Sin grupo asignado';
        } else if (pareja.fuera_de_horario) {
            // Pareja asignada pero fuera de su horario (AMARILLO)
            claseEstado = 'pareja-fuera-horario';
            iconoEstado = '<i class="bi bi-exclamation-circle-fill text-warning me-2" title="Fuera de horario preferido"></i>';
            tooltipEstado = 'Fuera de horario preferido';
        }
        
        fila.className = claseEstado;
        
        const franjas = pareja.franjas_disponibles ? pareja.franjas_disponibles.join(', ') : 'Sin especificar';
        
        fila.innerHTML = `
            <td>${index + 1}</td>
            <td class="fw-bold">${iconoEstado}${escapeHtml(pareja.nombre)}</td>
            <td><i class="bi bi-telephone"></i> ${escapeHtml(pareja.telefono)}</td>
            <td><span class="badge bg-secondary">${escapeHtml(pareja.categoria)}</span></td>
            <td><small>${escapeHtml(franjas)}</small></td>
            <td>
                <button class="btn btn-sm btn-primary me-1" 
                        data-pareja-id="${pareja.id}"
                        data-pareja-nombre="${escapeHtml(pareja.nombre)}"
                        data-pareja-telefono="${escapeHtml(pareja.telefono)}"
                        data-pareja-categoria="${escapeHtml(pareja.categoria)}"
                        data-pareja-franjas='${JSON.stringify(pareja.franjas_disponibles)}'
                        onclick="editarParejaTabla(this)"
                        title="Editar">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="eliminarPareja(${pareja.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        
        tbody.appendChild(fila);
    });
    
    // Actualizar contador en el header de la tabla
    const headerElement = document.querySelector('#headerTablaParejas');
    if (headerElement) {
        let headerHTML = `<i class="bi bi-list-ul"></i> Listado de Parejas (${parejas.length})`;
        
        // Contar parejas sin asignar y fuera de horario
        const sinAsignar = parejas.filter(p => !p.esta_asignada).length;
        const fueraHorario = parejas.filter(p => p.fuera_de_horario).length;
        
        if (sinAsignar > 0) {
            headerHTML += ` <span class="badge bg-danger ms-2">${sinAsignar} sin grupo</span>`;
        }
        if (fueraHorario > 0) {
            headerHTML += ` <span class="badge bg-warning text-dark ms-2">${fueraHorario} fuera de horario</span>`;
        }
        
        headerElement.innerHTML = headerHTML;
    }
}

function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

</script>
{% endblock %}
