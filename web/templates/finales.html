{% extends "base.html" %}

{% block title %}Finales - Torneo de P√°del{% endblock %}

{% block extra_css %}
<style>
    /* ========== ESTILOS GENERALES ========== */
    .finales-page {
        padding: 2rem 0;
        min-height: 100vh;
        background: #f8f9fa;
    }
    
    .page-header {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
    }
    
    .page-title {
        font-size: 3rem;
        font-weight: 800;
        color: #2d3748;
        margin: 0;
    }
    
    .page-subtitle {
        font-size: 1.1rem;
        color: #718096;
        margin: 0.5rem 0 0 0;
    }
    
    /* ========== TABS PRINCIPALES ========== */
    #mainTabs {
        max-width: 900px;
        margin: 0 auto;
    }
    
    #mainTabs .nav-link {
        border-radius: 15px;
        padding: 0.7rem 4rem;
        font-size: 1.1rem;
        color: #4a5568;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin: 0 0.5rem;
    }
    
    #mainTabs .nav-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        color: #2d3748;
    }
    
    #mainTabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: 2px solid #667eea;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    #mainTabs .nav-link small {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    /* ========== SELECTOR DE CATEGOR√çA ========== */
    .categorias-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .categoria-btn {
        padding: 1.5rem;
        border-radius: 16px;
        background: white;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    .categoria-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .categoria-btn.active {
        border-color: currentColor;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }
    
    .categoria-btn-cuarta { color: #28a745; }
    .categoria-btn-quinta { color: #ffc107; }
    .categoria-btn-sexta { color: #17a2b8; }
    .categoria-btn-septima { color: #9b7fed; }
    
    .categoria-btn .categoria-emoji {
        font-size: 2rem;
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .categoria-btn .categoria-nombre {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
    }
    
    .categoria-btn .categoria-fases {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    /* ========== ESTILOS ESTILO ITF ========== */
    .draw-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .round-section {
        margin-bottom: 3rem;
    }
    
    .round-header {
        text-align: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 3px solid #e9ecef;
    }
    
    .round-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: #2d3748;
        margin: 0;
        text-transform: uppercase;
        letter-spacing: 1px;
    }
    
    .matches-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
        gap: 1.5rem;
    }
    
    /* ========== PARTIDO (MATCH) ========== */
    .match-card {
        background: #f8f9fa;
        border-radius: 12px;
        overflow: hidden;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .match-card:hover {
        border-color: #667eea;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }
    
    .match-header {
        background: #e9ecef;
        padding: 0.5rem 1rem;
        font-size: 0.85rem;
        font-weight: 600;
        color: #6c757d;
        text-align: center;
    }
    
    .match-players {
        padding: 0;
    }
    
    .player-row {
        display: flex;
        align-items: center;
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .player-row:last-child {
        border-bottom: none;
    }
    
    .player-row:hover:not(.winner):not(.por-definir) {
        background: #f1f3f5;
    }
    
    .player-row.winner {
        background: linear-gradient(90deg, #e7f5ff 0%, #d0ebff 100%);
        font-weight: 700;
    }
    
    .player-row.por-definir {
        opacity: 0.5;
        cursor: not-allowed;
        font-style: italic;
        color: #adb5bd;
    }
    
    .player-position {
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #6c757d;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        margin-right: 1rem;
        flex-shrink: 0;
    }
    
    .player-row.winner .player-position {
        background: #4c6ef5;
    }
    
    .player-name {
        flex: 1;
        font-size: 1rem;
    }
    
    .player-score {
        display: flex;
        gap: 0.5rem;
        margin-left: 1rem;
    }
    
    .score-set {
        width: 32px;
        height: 32px;
        border-radius: 6px;
        background: white;
        border: 2px solid #dee2e6;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.9rem;
        color: #495057;
    }
    
    .player-row.winner .score-set {
        border-color: #4c6ef5;
        color: #4c6ef5;
    }
    
    .winner-check {
        margin-left: 0.75rem;
        color: #4c6ef5;
        font-size: 1.25rem;
    }
    
    /* ========== L√çNEAS CONECTORAS ========== */
    .rounds-connector {
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 2rem 0;
    }
    
    .connector-line {
        flex: 1;
        height: 3px;
        background: linear-gradient(90deg, transparent 0%, #667eea 50%, transparent 100%);
        position: relative;
    }
    
    .connector-arrow {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        background: #667eea;
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin: 0 1rem;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    /* ========== BOTONES FLOTANTES ========== */
    .floating-actions {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 1000;
    }
    
    .btn-float {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .btn-float:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        color: white;
    }
    
    .btn-float-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* ========== BOTONES DE ACCI√ìN ========== */
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .btn-regenerar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-regenerar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    /* ========== CALENDARIO DOMINGO ========== */
    .calendario-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .horario-section {
        margin-bottom: 2rem;
    }
    
    .horario-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .canchas-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    .cancha-column {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    .cancha-header {
        font-size: 1.1rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #667eea;
    }
    
    .partido-calendario {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }
    
    .partido-calendario:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .partido-cuarta { border-left-color: #28a745; }
    .partido-quinta { border-left-color: #ffc107; }
    .partido-sexta { border-left-color: #17a2b8; }
    .partido-septima { border-left-color: #9b7fed; }
    
    .partido-hora {
        font-weight: 700;
        font-size: 1.1rem;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }
    
    .partido-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .partido-parejas {
        font-size: 0.95rem;
        color: #495057;
        font-weight: 500;
    }
    
    .pausa-section {
        text-align: center;
        padding: 1.5rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        border-radius: 12px;
        margin: 2rem 0;
        border: 2px dashed #ffc107;
    }
    
    .pausa-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .pausa-text {
        font-size: 1.2rem;
        font-weight: 700;
        color: #856404;
        margin: 0;
    }
    
    /* ========== EMPTY STATE ========== */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #adb5bd;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .empty-state-text {
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .matches-grid {
            grid-template-columns: 1fr;
        }
        
        .canchas-row {
            grid-template-columns: 1fr;
        }
        
        .categorias-selector {
            grid-template-columns: 1fr 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid finales-page">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">
            <!-- Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="bi bi-trophy-fill me-3"></i>FINALES
                </h1>
                <p class="page-subtitle">Llaves eliminatorias y calendario del domingo</p>
            </div>
            
            <!-- Tabs Principales -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <ul class="nav nav-pills nav-fill mb-2 justify-content-center" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="llaves-tab" data-bs-toggle="pill" 
                                    data-bs-target="#llaves-content" type="button" role="tab" 
                                    aria-controls="llaves-content" aria-selected="true">
                                <i class="bi bi-diagram-3 me-2" style="font-size: 1.3rem;"></i>
                                <strong>LLAVES</strong>
                                <small class="d-block">Sistema Eliminatorio</small>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="calendario-tab" data-bs-toggle="pill" 
                                    data-bs-target="#calendario-content" type="button" role="tab" 
                                    aria-controls="calendario-content" aria-selected="false"
                                    onclick="cargarCalendario()">
                                <i class="bi bi-calendar-week me-2" style="font-size: 1.3rem;"></i>
                                <strong>CALENDARIO DOMINGO</strong>
                                <small class="d-block">Horarios y Canchas</small>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Contenido de Tabs -->
            <div class="tab-content">
                <!-- TAB: LLAVES -->
                <div class="tab-pane fade show active" id="llaves-content" role="tabpanel">
                    <!-- Botones de Acci√≥n -->
                    <div class="action-buttons">
                        <button class="btn btn-regenerar" onclick="regenerarFixtures()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Regenerar Llaves
                        </button>
                    </div>
                    
                    <!-- Selector de Categor√≠a -->
                    <div class="categorias-selector" id="categoriasSelector">
                        <div class="categoria-btn categoria-btn-cuarta active" onclick="cambiarCategoria('4ta')">
                            <span class="categoria-emoji">üü¢</span>
                            <h3 class="categoria-nombre">4ta</h3>
                            <p class="categoria-fases mb-0" id="fases-4ta">Cargando...</p>
                        </div>
                        <div class="categoria-btn categoria-btn-quinta" onclick="cambiarCategoria('5ta')">
                            <span class="categoria-emoji">üü°</span>
                            <h3 class="categoria-nombre">5ta</h3>
                            <p class="categoria-fases mb-0" id="fases-5ta">Cargando...</p>
                        </div>
                        <div class="categoria-btn categoria-btn-sexta" onclick="cambiarCategoria('6ta')">
                            <span class="categoria-emoji">üîµ</span>
                            <h3 class="categoria-nombre">6ta</h3>
                            <p class="categoria-fases mb-0" id="fases-6ta">Cargando...</p>
                        </div>
                        <div class="categoria-btn categoria-btn-septima" onclick="cambiarCategoria('7ma')">
                            <span class="categoria-emoji">üü£</span>
                            <h3 class="categoria-nombre">7ma</h3>
                            <p class="categoria-fases mb-0" id="fases-7ma">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Contenedor de Llaves -->
                    <div id="drawContainer" class="draw-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">üèÜ</div>
                            <p class="empty-state-text">Selecciona una categor√≠a para ver las llaves</p>
                        </div>
                    </div>
                </div>
                
                <!-- TAB: CALENDARIO DOMINGO -->
                <div class="tab-pane fade" id="calendario-content" role="tabpanel">
                    <div id="calendarioContainer" class="calendario-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p class="empty-state-text">Cargando calendario...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n de Acci√≥n Flotante -->
<div class="floating-actions">
    <a href="{{ url_for('resultados') }}" class="btn-float btn-float-primary" title="Volver a Grupos">
        <i class="bi bi-arrow-left"></i>
    </a>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999"></div>
{% endblock %}

{% block extra_js %}
<script>
let currentCategoria = '4ta';
let fixtures = {};

// Cargar fixtures al inicio
document.addEventListener('DOMContentLoaded', function() {
    cargarFixtures();
    
    // Auto-actualizar cada 30 segundos
    setInterval(() => {
        cargarFixtures();
    }, 30000);
});

// Cargar todos los fixtures
async function cargarFixtures() {
    try {
        const response = await fetch('/api/finales/fixtures');
        const data = await response.json();
        
        if (data.success) {
            fixtures = data.fixtures;
            actualizarDetallesCategorias();
            cambiarCategoria('4ta'); // Mostrar 4ta por defecto
        }
    } catch (error) {
        console.error('Error al cargar fixtures:', error);
    }
}

// Actualizar detalles de categor√≠as (fases disponibles)
function actualizarDetallesCategorias() {
    const categorias = ['4ta', '5ta', '6ta', '7ma'];
    
    categorias.forEach(cat => {
        const fixture = fixtures[cat];
        let fases = [];
        
        if (fixture) {
            if (fixture.octavos && fixture.octavos.length > 0) fases.push('Octavos');
            if (fixture.cuartos && fixture.cuartos.length > 0) fases.push('Cuartos');
            if (fixture.semifinales && fixture.semifinales.length > 0) fases.push('Semis');
            if (fixture.final) fases.push('Final');
        }
        
        const fasesText = fases.length > 0 ? fases.join(' ‚Ä¢ ') : 'Sin fases';
        document.getElementById(`fases-${cat}`).textContent = fasesText;
    });
}

// Cambiar categor√≠a
function cambiarCategoria(categoria) {
    currentCategoria = categoria;
    
    // Actualizar botones activos
    document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
    event.target.closest('.categoria-btn').classList.add('active');
    
    // Renderizar fixture
    renderizarFixture(categoria);
}

// Renderizar fixture estilo ITF
function renderizarFixture(categoria) {
    const container = document.getElementById('drawContainer');
    const fixture = fixtures[categoria];
    
    // Si no existe el fixture en absoluto, crear estructura vac√≠a
    if (!fixture) {
        // Crear estructura de llaves vac√≠as por defecto (depende de la categor√≠a)
        const partidosVacios = crearPartidosVacios(categoria);
        container.innerHTML = partidosVacios;
        return;
    }
    
    let html = '';
    let hasAnyRound = false;
    
    // Octavos
    if (fixture.octavos && fixture.octavos.length > 0) {
        hasAnyRound = true;
        html += renderizarRonda('Octavos de Final', fixture.octavos);
        html += `<div class="rounds-connector">
                    <div class="connector-line"></div>
                    <div class="connector-arrow"><i class="bi bi-arrow-down"></i></div>
                    <div class="connector-line"></div>
                </div>`;
    }
    
    // Cuartos
    if (fixture.cuartos && fixture.cuartos.length > 0) {
        hasAnyRound = true;
        html += renderizarRonda('Cuartos de Final', fixture.cuartos);
        html += `<div class="rounds-connector">
                    <div class="connector-line"></div>
                    <div class="connector-arrow"><i class="bi bi-arrow-down"></i></div>
                    <div class="connector-line"></div>
                </div>`;
    }
    
    // Semifinales
    if (fixture.semifinales && fixture.semifinales.length > 0) {
        hasAnyRound = true;
        html += renderizarRonda('Semifinales', fixture.semifinales);
        html += `<div class="rounds-connector">
                    <div class="connector-line"></div>
                    <div class="connector-arrow"><i class="bi bi-arrow-down"></i></div>
                    <div class="connector-line"></div>
                </div>`;
    }
    
    // Final - siempre mostrar
    if (fixture.final) {
        hasAnyRound = true;
        html += renderizarRonda('Final', [fixture.final]);
    }
    
    // Si no hay ninguna ronda configurada, mostrar llaves vac√≠as
    if (!hasAnyRound) {
        html = crearPartidosVacios(categoria);
    }
    
    container.innerHTML = html;
}

// Crear estructura de partidos vac√≠os
function crearPartidosVacios(categoria) {
    // Todas las categor√≠as tienen semifinal y final
    return `
        <div class="round-section">
            <div class="round-header">
                <h2 class="round-title">SEMIFINALES</h2>
            </div>
            <div class="matches-grid">
                ${renderizarPartidoVacio(1)}
                ${renderizarPartidoVacio(2)}
            </div>
        </div>
        <div class="rounds-connector">
            <div class="connector-line"></div>
            <div class="connector-arrow"><i class="bi bi-arrow-down"></i></div>
            <div class="connector-line"></div>
        </div>
        <div class="round-section">
            <div class="round-header">
                <h2 class="round-title">FINAL</h2>
            </div>
            <div class="matches-grid">
                ${renderizarPartidoVacio(1)}
            </div>
        </div>
    `;
}

// Renderizar un partido vac√≠o
function renderizarPartidoVacio(numero) {
    return `
        <div class="match-card">
            <div class="match-header">Partido ${numero}</div>
            <div class="match-players">
                <div class="player-row por-definir">
                    <div class="player-position">1</div>
                    <div class="player-name">‚Äî Por definir ‚Äî</div>
                </div>
                <div class="player-row por-definir">
                    <div class="player-position">2</div>
                    <div class="player-name">‚Äî Por definir ‚Äî</div>
                </div>
            </div>
        </div>
    `;
}

// Renderizar una ronda completa
function renderizarRonda(titulo, partidos) {
    let html = `
        <div class="round-section">
            <div class="round-header">
                <h2 class="round-title">${titulo}</h2>
            </div>
            <div class="matches-grid">
    `;
    
    partidos.forEach((partido, idx) => {
        html += renderizarPartido(partido, idx + 1);
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

// Renderizar un partido individual
function renderizarPartido(partido, numero) {
    const pareja1 = partido.pareja1 ? partido.pareja1.nombre : '‚Äî Por definir ‚Äî';
    const pareja2 = partido.pareja2 ? partido.pareja2.nombre : '‚Äî Por definir ‚Äî';
    const ganador = partido.ganador ? partido.ganador.id : null;
    
    const pareja1Class = ganador === (partido.pareja1 ? partido.pareja1.id : null) ? 'winner' : '';
    const pareja2Class = ganador === (partido.pareja2 ? partido.pareja2.id : null) ? 'winner' : '';
    const porDefinir1 = !partido.pareja1 ? 'por-definir' : '';
    const porDefinir2 = !partido.pareja2 ? 'por-definir' : '';
    
    return `
        <div class="match-card">
            <div class="match-header">Partido ${numero}</div>
            <div class="match-players">
                <div class="player-row ${pareja1Class} ${porDefinir1}" 
                     onclick="${partido.pareja1 && !ganador ? `marcarGanador('${partido.id}', ${partido.pareja1.id})` : ''}"
                     style="${!partido.pareja1 || ganador ? 'cursor: default;' : ''}">
                    <div class="player-position">1</div>
                    <div class="player-name">${pareja1}</div>
                    ${pareja1Class ? '<i class="bi bi-check-circle-fill winner-check"></i>' : ''}
                </div>
                <div class="player-row ${pareja2Class} ${porDefinir2}"
                     onclick="${partido.pareja2 && !ganador ? `marcarGanador('${partido.id}', ${partido.pareja2.id})` : ''}"
                     style="${!partido.pareja2 || ganador ? 'cursor: default;' : ''}">
                    <div class="player-position">2</div>
                    <div class="player-name">${pareja2}</div>
                    ${pareja2Class ? '<i class="bi bi-check-circle-fill winner-check"></i>' : ''}
                </div>
            </div>
        </div>
    `;
}

// Marcar ganador
async function marcarGanador(partidoId, ganadorId) {
    try {
        const response = await fetch(`/api/finales/partido/${partidoId}/ganador`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ganador_id: ganadorId })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Ganador actualizado correctamente', 'success');
            await cargarFixtures(); // Recargar fixtures
        } else {
            showToast('Error al actualizar ganador: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'danger');
    }
}

// Regenerar fixtures
async function regenerarFixtures() {
    if (!confirm('¬øEst√°s seguro de regenerar las llaves? Esto actualizar√° las parejas clasificadas bas√°ndose en las posiciones actuales de los grupos.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/finales/fixtures/regenerar', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Llaves regeneradas correctamente', 'success');
            await cargarFixtures();
        } else {
            showToast('Error al regenerar: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'danger');
    }
}

// Cargar calendario
async function cargarCalendario() {
    const container = document.getElementById('calendarioContainer');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const response = await fetch('/api/finales/calendario');
        const data = await response.json();
        
        if (data.success) {
            renderizarCalendario(data.calendario);
        } else {
            container.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
        }
    } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="alert alert-danger">Error al cargar el calendario</div>';
    }
}

// Renderizar calendario
function renderizarCalendario(calendario) {
    const container = document.getElementById('calendarioContainer');
    
    // Agrupar por bloques horarios (ma√±ana y tarde)
    const cancha1 = calendario.cancha_1 || [];
    const cancha2 = calendario.cancha_2 || [];
    
    // Si no hay partidos, mostrar mensaje
    if (cancha1.length === 0 && cancha2.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÖ</div>
                <p class="empty-state-text">El calendario se generar√° autom√°ticamente</p>
                <p class="text-muted mt-2">Una vez que las llaves est√©n definidas</p>
            </div>
        `;
        return;
    }
    
    // Separar en bloques
    const mananaC1 = cancha1.filter(p => parseInt(p.hora_inicio.split(':')[0]) < 15);
    const tardeC1 = cancha1.filter(p => parseInt(p.hora_inicio.split(':')[0]) >= 16);
    const mananaC2 = cancha2.filter(p => parseInt(p.hora_inicio.split(':')[0]) < 15);
    const tardeC2 = cancha2.filter(p => parseInt(p.hora_inicio.split(':')[0]) >= 16);
    
    let html = '';
    
    // Bloque Ma√±ana
    if (mananaC1.length > 0 || mananaC2.length > 0) {
        html += `
            <div class="horario-section">
                <h3 class="horario-title">
                    <i class="bi bi-sunrise"></i>
                    Bloque Ma√±ana
                </h3>
                <div class="canchas-row">
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-1-circle-fill me-2"></i>Cancha 1</div>
                        ${renderizarPartidosCalendario(mananaC1)}
                    </div>
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-2-circle-fill me-2"></i>Cancha 2</div>
                        ${renderizarPartidosCalendario(mananaC2)}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Solo mostrar pausa si hay partidos en ma√±ana Y en tarde
    if ((mananaC1.length > 0 || mananaC2.length > 0) && (tardeC1.length > 0 || tardeC2.length > 0)) {
        html += `
            <div class="pausa-section">
                <div class="pausa-icon">‚è∏Ô∏è</div>
                <p class="pausa-text">PAUSA</p>
                <small class="text-muted">No se juega en ninguna cancha</small>
            </div>
        `;
    }
    
    // Bloque Tarde
    if (tardeC1.length > 0 || tardeC2.length > 0) {
        html += `
            <div class="horario-section">
                <h3 class="horario-title">
                    <i class="bi bi-sunset"></i>
                    Bloque Tarde
                </h3>
                <div class="canchas-row">
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-1-circle-fill me-2"></i>Cancha 1</div>
                        ${renderizarPartidosCalendario(tardeC1)}
                    </div>
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-2-circle-fill me-2"></i>Cancha 2</div>
                        ${renderizarPartidosCalendario(tardeC2)}
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Renderizar partidos del calendario
function renderizarPartidosCalendario(partidos) {
    if (partidos.length === 0) {
        return '<p class="text-muted text-center py-3">Sin partidos asignados</p>';
    }
    
    return partidos.map(p => {
        const categoriaClass = `partido-${p.categoria.toLowerCase()}`;
        const pareja1 = p.pareja1 || 'Por definir';
        const pareja2 = p.pareja2 || 'Por definir';
        
        return `
            <div class="partido-calendario ${categoriaClass}">
                <div class="partido-hora">${p.hora_inicio}</div>
                <div class="partido-info">
                    <strong>${p.categoria}</strong> - ${p.fase}
                </div>
                <div class="partido-parejas">
                    ${pareja1} <strong>vs</strong> ${pareja2}
                </div>
            </div>
        `;
    }).join('');
}

// Toast helper
function showToast(message, type = 'info') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    const container = document.querySelector('.toast-container');
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastEl = container.lastElementChild;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}
</script>
{% endblock %}
