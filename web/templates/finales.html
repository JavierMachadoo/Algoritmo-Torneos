{% extends "base.html" %}

{% block title %}Finales - Torneo de P√°del{% endblock %}

{% block extra_css %}
<style>
    /* ========== ESTILOS GENERALES ========== */
    .finales-page {
        padding: 2rem 0;
        min-height: 100vh;
        background: #f8f9fa;
    }
    
    .page-header {
        background: white;
        padding: 2rem;
        border-radius: 20px;
        margin-bottom: 1rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
    }
    
    .page-title {
        font-size: 3rem;
        font-weight: 800;
        color: #2d3748;
        margin: 0;
    }
    
    .page-subtitle {
        font-size: 1.1rem;
        color: #718096;
        margin: 0.5rem 0 0 0;
    }
    
    /* ========== TABS PRINCIPALES ========== */
    #mainTabs {
        max-width: 900px;
        margin: 0 auto;
    }
    
    #mainTabs .nav-link {
        border-radius: 15px;
        padding: 0.7rem 4rem;
        font-size: 1.1rem;
        color: #4a5568;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        background: white;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        margin: 0 0.5rem;
    }
    
    #mainTabs .nav-link:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        color: #2d3748;
    }
    
    #mainTabs .nav-link.active {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: 2px solid #667eea;
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    
    #mainTabs .nav-link small {
        font-size: 0.85rem;
        opacity: 0.9;
    }
    
    /* ========== SELECTOR DE CATEGOR√çA ========== */
    .categorias-selector {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .categoria-btn {
        padding: 1.5rem;
        border-radius: 16px;
        background: white;
        border: 3px solid transparent;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    
    .categoria-btn:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
    .categoria-btn.active {
        border-color: currentColor;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }
    
    .categoria-btn-cuarta { color: #28a745; }
    .categoria-btn-quinta { color: #ffc107; }
    .categoria-btn-sexta { color: #17a2b8; }
    .categoria-btn-septima { color: #9b7fed; }
    
    .categoria-btn .categoria-emoji {
        font-size: 2rem;
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .categoria-btn .categoria-nombre {
        font-size: 1.3rem;
        font-weight: 700;
        margin: 0;
    }
    
    .categoria-btn .categoria-fases {
        font-size: 0.85rem;
        opacity: 0.7;
        margin-top: 0.25rem;
    }
    
    /* ========== ESTILOS ESTILO ITF ========== */
    .draw-container {
        background: #fafbfc;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.06);
        overflow-x: auto;
    }
    
    /* Layout horizontal de llaves */
    .draw-grid {
        display: flex;
        gap: 5rem;
        min-width: fit-content;
        padding: 1.5rem;
        align-items: stretch;
        position: relative;
        min-height: 800px;
    }
    
    .round-column {
        display: flex;
        flex-direction: column;
        min-width: 320px;
        position: relative;
        height: 100%;
    }
    
    /* Posicionamiento espec√≠fico para cada ronda */
    .round-column .matches-column {
        display: grid;
        grid-auto-rows: minmax(100px, 1fr);
        gap: 2rem;
        align-content: center;
        flex: 1;
    }
    
    /* Cuartos: 4 partidos distribuidos uniformemente */
    .round-column .matches-column .match-wrapper:nth-child(1) { grid-row: 1; }
    .round-column .matches-column .match-wrapper:nth-child(2) { grid-row: 2; }
    .round-column .matches-column .match-wrapper:nth-child(3) { grid-row: 3; }
    .round-column .matches-column .match-wrapper:nth-child(4) { grid-row: 4; }
    
    /* Semis: 2 partidos centrados entre pares de cuartos */
    .round-column:has(.match-wrapper:nth-child(2):last-child) .matches-column {
        grid-template-rows: repeat(4, minmax(100px, 1fr));
    }
    .round-column:has(.match-wrapper:nth-child(2):last-child) .match-wrapper:nth-child(1) { 
        grid-row: 1 / 3; 
        align-self: center;
    }
    .round-column:has(.match-wrapper:nth-child(2):last-child) .match-wrapper:nth-child(2) { 
        grid-row: 3 / 5; 
        align-self: center;
    }
    
    /* Final: 1 partido centrado en medio de todo */
    .round-column:has(.match-wrapper:only-child) .matches-column {
        grid-template-rows: repeat(4, minmax(100px, 1fr));
    }
    .round-column:has(.match-wrapper:only-child) .match-wrapper { 
        grid-row: 2 / 4; 
        align-self: center;
    }
    
    .round-header-itf {
        text-align: center;
        padding: 0.9rem 1.5rem;
        margin-bottom: 2.5rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 12px;
        font-size: 0.95rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1.2px;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.35);
    }
    
    .position-badges {
        margin-top: 0.5rem;
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        flex-wrap: wrap;
    }
    
    .position-badges .badge {
        font-size: 0.75rem;
        font-weight: 600;
        padding: 0.35rem 0.7rem;
        text-transform: none;
        letter-spacing: 0.5px;
    }
    
    .round-column.third-place {
        opacity: 0.95;
    }
    
    .matches-column {
        display: grid;
        grid-auto-rows: minmax(100px, 1fr);
        gap: 2rem;
        align-content: center;
        flex: 1;
        position: relative;
    }
    
    .match-wrapper {
        position: relative;
    }
    
    /* ========== PARTIDO (MATCH) ESTILO ITF ========== */
    .match-card-itf {
        background: white;
        border: 2px solid #cbd5e1;
        border-radius: 10px;
        overflow: hidden;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.08);
        position: relative;
        min-width: 280px;
    }
    
    .match-card-itf:hover {
        border-color: #667eea;
        box-shadow: 0 4px 18px rgba(102, 126, 234, 0.2);
        transform: translateX(3px);
    }
    
    .player-row-itf {
        display: grid;
        grid-template-columns: 1fr auto auto;
        align-items: center;
        gap: 0.75rem;
        padding: 0.9rem 1rem;
        border-bottom: 2px solid #e2e8f0;
        transition: all 0.2s ease;
        min-height: 52px;
        background: white;
    }
    
    .player-row-itf:last-child {
        border-bottom: none;
    }
    
    .player-row-itf.winner {
        background: linear-gradient(90deg, #eff6ff 0%, #dbeafe 100%);
        font-weight: 600;
        border-left: 4px solid #3b82f6;
    }
    
    .player-row-itf.por-definir {
        opacity: 0.45;
        font-style: italic;
        color: #94a3b8;
    }
    
    .player-name-itf {
        font-size: 0.9rem;
        font-weight: 500;
        color: #1e293b;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .player-row-itf.winner .player-name-itf {
        font-weight: 600;
        color: #1e40af;
    }
    
    .player-scores {
        display: flex;
        gap: 0.4rem;
        align-items: center;
    }
    
    .score-set {
        min-width: 30px;
        height: 30px;
        border-radius: 5px;
        background: #f1f5f9;
        border: 1.5px solid #cbd5e1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.85rem;
        color: #475569;
        transition: all 0.2s ease;
    }
    
    .player-row-itf.winner .score-set {
        background: #bfdbfe;
        border-color: #3b82f6;
        color: #1e40af;
        box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.1);
    }
    
    .player-check {
        color: #10b981;
        font-size: 1.1rem;
        margin-left: 0.25rem;
    }
    
    /* ========== SISTEMA DE CONEXIONES SVG ========== */
    .bracket-connections {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 0;
    }
    
    .bracket-connections svg {
        width: 100%;
        height: 100%;
    }
    
    .bracket-line {
        stroke: #94a3b8;
        stroke-width: 2;
        fill: none;
        stroke-linecap: round;
        stroke-linejoin: round;
    }
    
    .bracket-line.winner-path {
        stroke: #667eea;
        stroke-width: 3;
    }
    
    /* Asegurar que las tarjetas est√©n sobre las l√≠neas */
    .match-card-itf {
        position: relative;
        z-index: 1;
    }
    
    /* ========== BOTONES FLOTANTES ========== */
    .floating-actions {
        position: fixed;
        bottom: 2rem;
        right: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
        z-index: 1000;
    }
    
    .btn-float {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        color: white;
        text-decoration: none;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }
    
    .btn-float:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        color: white;
    }
    
    .btn-float-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* ========== BOTONES DE ACCI√ìN ========== */
    .action-buttons {
        display: flex;
        gap: 1rem;
        margin-bottom: 2rem;
    }
    
    .btn-regenerar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 50px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-regenerar:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        color: white;
    }
    
    /* ========== CALENDARIO DOMINGO ========== */
    .calendario-container {
        background: white;
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    }
    
    .horario-section {
        margin-bottom: 2rem;
    }
    
    .horario-title {
        font-size: 1.3rem;
        font-weight: 700;
        color: #2d3748;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .canchas-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    .cancha-column {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 1.5rem;
    }
    
    .cancha-header {
        font-size: 1.1rem;
        font-weight: 700;
        color: #667eea;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #667eea;
    }
    
    .partido-calendario {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border-left: 4px solid;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        transition: all 0.2s ease;
    }
    
    .partido-calendario:hover {
        transform: translateX(5px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .partido-cuarta { border-left-color: #28a745; }
    .partido-quinta { border-left-color: #ffc107; }
    .partido-sexta { border-left-color: #17a2b8; }
    .partido-septima { border-left-color: #9b7fed; }
    
    .partido-hora {
        font-weight: 700;
        font-size: 1.1rem;
        color: #2d3748;
        margin-bottom: 0.25rem;
    }
    
    .partido-info {
        font-size: 0.9rem;
        color: #6c757d;
        margin-bottom: 0.25rem;
    }
    
    .partido-parejas {
        font-size: 0.95rem;
        color: #495057;
        font-weight: 500;
    }
    
    .pausa-section {
        text-align: center;
        padding: 1.5rem;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
        border-radius: 12px;
        margin: 2rem 0;
        border: 2px dashed #ffc107;
    }
    
    .pausa-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
    }
    
    .pausa-text {
        font-size: 1.2rem;
        font-weight: 700;
        color: #856404;
        margin: 0;
    }
    
    /* ========== EMPTY STATE ========== */
    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: #adb5bd;
    }
    
    .empty-state-icon {
        font-size: 4rem;
        margin-bottom: 1rem;
    }
    
    .empty-state-text {
        font-size: 1.2rem;
        font-weight: 600;
    }
    
    /* ========== RESPONSIVE ========== */
    @media (max-width: 768px) {
        .matches-grid {
            grid-template-columns: 1fr;
        }
        
        .canchas-row {
            grid-template-columns: 1fr;
        }
        
        .categorias-selector {
            grid-template-columns: 1fr 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid finales-page">
    <div class="row justify-content-center">
        <div class="col-lg-11 col-xl-10">
            <!-- Header -->
            <div class="page-header">
                <h1 class="page-title">
                    <i class="bi bi-trophy-fill me-3"></i>FINALES 
                </h1>
                <p class="page-subtitle">Llaves eliminatorias y calendario del domingo</p>
            </div>
            
            <!-- Tabs Principales -->
            <div class="row justify-content-center mb-4">
                <div class="col-lg-10">
                    <ul class="nav nav-pills nav-fill mb-2 justify-content-center" id="mainTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="llaves-tab" data-bs-toggle="pill" 
                                    data-bs-target="#llaves-content" type="button" role="tab" 
                                    aria-controls="llaves-content" aria-selected="true">
                                <i class="bi bi-diagram-3 me-2" style="font-size: 1.3rem;"></i>
                                <strong>LLAVES</strong>
                                <small class="d-block">Sistema Eliminatorio</small>
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="calendario-tab" data-bs-toggle="pill" 
                                    data-bs-target="#calendario-content" type="button" role="tab" 
                                    aria-controls="calendario-content" aria-selected="false"
                                    onclick="cargarCalendario()">
                                <i class="bi bi-calendar-week me-2" style="font-size: 1.3rem;"></i>
                                <strong>CALENDARIO DOMINGO</strong>
                                <small class="d-block">Horarios y Canchas</small>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <!-- Contenido de Tabs -->
            <div class="tab-content">
                <!-- TAB: LLAVES -->
                <div class="tab-pane fade show active" id="llaves-content" role="tabpanel">
                    <!-- Botones de Acci√≥n -->
                    <div class="action-buttons">
                        <button class="btn btn-regenerar" onclick="regenerarFixtures()">
                            <i class="bi bi-arrow-clockwise me-2"></i>Regenerar Llaves
                        </button>
                    </div>
                    
                    <!-- Selector de Categor√≠a -->
                    <div class="categorias-selector" id="categoriasSelector">
                        <div class="categoria-btn categoria-btn-cuarta active" onclick="cambiarCategoria('4ta', event)">
                            <span class="categoria-emoji">üü¢</span>
                            <h3 class="categoria-nombre">4ta</h3>
                            <p class="categoria-fases mb-0" id="fases-4ta">Cargando...</p>
                        </div>
                        <div class="categoria-btn categoria-btn-quinta" onclick="cambiarCategoria('5ta', event)">
                            <span class="categoria-emoji">üü°</span>
                            <h3 class="categoria-nombre">5ta</h3>
                            <p class="categoria-fases mb-0" id="fases-5ta">Cargando...</p>
                        </div>
                        <div class="categoria-btn categoria-btn-sexta" onclick="cambiarCategoria('6ta', event)">
                            <span class="categoria-emoji">üîµ</span>
                            <h3 class="categoria-nombre">6ta</h3>
                            <p class="categoria-fases mb-0" id="fases-6ta">Cargando...</p>
                        </div>
                        <div class="categoria-btn categoria-btn-septima" onclick="cambiarCategoria('7ma', event)">
                            <span class="categoria-emoji">üü£</span>
                            <h3 class="categoria-nombre">7ma</h3>
                            <p class="categoria-fases mb-0" id="fases-7ma">Cargando...</p>
                        </div>
                    </div>
                    
                    <!-- Contenedor de Llaves -->
                    <div id="drawContainer" class="draw-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">üèÜ</div>
                            <p class="empty-state-text">Selecciona una categor√≠a para ver las llaves</p>
                        </div>
                    </div>
                </div>
                
                <!-- TAB: CALENDARIO DOMINGO -->
                <div class="tab-pane fade" id="calendario-content" role="tabpanel">
                    <div id="calendarioContainer" class="calendario-container">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìÖ</div>
                            <p class="empty-state-text">Cargando calendario...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Bot√≥n de Acci√≥n Flotante -->
<div class="floating-actions">
    <a href="{{ url_for('resultados') }}" class="btn-float btn-float-primary" title="Volver a Grupos">
        <i class="bi bi-arrow-left"></i>
    </a>
</div>

<!-- Modal Ingresar Resultado de Partido Final -->
<div class="modal fade" id="modalResultadoFinal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; overflow: hidden; border: none;">
            <div class="modal-header text-white" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 1.5rem;">
                <h5 class="modal-title fw-bold">
                    <i class="bi bi-trophy-fill me-2"></i> Resultado del Partido
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <form id="formResultadoFinal">
                    <input type="hidden" id="resultadoPartidoId">
                    <input type="hidden" id="resultadoFase">
                    <input type="hidden" id="resultadoCategoria">
                    
                    <!-- Nombres de las parejas -->
                    <div class="d-flex justify-content-between align-items-center mb-4" style="padding: 1.5rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 15px;">
                        <div class="text-center flex-fill">
                            <h5 class="fw-bold mb-0 text-primary" id="resultadoFinalPareja1" style="font-size: 1.1rem;">Pareja 1</h5>
                        </div>
                        <div class="text-center px-3">
                            <div class="badge bg-dark" style="font-size: 1rem; padding: 0.5rem 1rem;">VS</div>
                        </div>
                        <div class="text-center flex-fill">
                            <h5 class="fw-bold mb-0 text-primary" id="resultadoFinalPareja2" style="font-size: 1.1rem;">Pareja 2</h5>
                        </div>
                    </div>
                    
                    <!-- Sets -->
                    <div class="mb-4">
                        <!-- Set 1 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted" style="font-size: 0.85rem;">
                                <i class="bi bi-circle-fill text-primary" style="font-size: 0.6rem;"></i> PRIMER SET
                            </label>
                            <div class="d-flex gap-3 align-items-center">
                                <input type="number" class="form-control form-control-lg text-center fw-bold" 
                                       id="gamesSet1P1" min="0" max="6" required
                                       placeholder="0"
                                       style="font-size: 2rem; height: 70px; border-radius: 12px; border: 2px solid #dee2e6;">
                                <div class="text-muted fw-bold" style="font-size: 1.5rem;">-</div>
                                <input type="number" class="form-control form-control-lg text-center fw-bold" 
                                       id="gamesSet1P2" min="0" max="6" required
                                       placeholder="0"
                                       style="font-size: 2rem; height: 70px; border-radius: 12px; border: 2px solid #dee2e6;">
                            </div>
                        </div>
                        
                        <!-- Set 2 -->
                        <div class="mb-3">
                            <label class="form-label fw-bold text-muted" style="font-size: 0.85rem;">
                                <i class="bi bi-circle-fill text-primary" style="font-size: 0.6rem;"></i> SEGUNDO SET
                            </label>
                            <div class="d-flex gap-3 align-items-center">
                                <input type="number" class="form-control form-control-lg text-center fw-bold" 
                                       id="gamesSet2P1" min="0" max="6" required
                                       placeholder="0"
                                       style="font-size: 2rem; height: 70px; border-radius: 12px; border: 2px solid #dee2e6;">
                                <div class="text-muted fw-bold" style="font-size: 1.5rem;">-</div>
                                <input type="number" class="form-control form-control-lg text-center fw-bold" 
                                       id="gamesSet2P2" min="0" max="6" required
                                       placeholder="0"
                                       style="font-size: 2rem; height: 70px; border-radius: 12px; border: 2px solid #dee2e6;">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Super Tie-break -->
                    <div id="tiebreakCardFinal" style="display: none;">
                        <div class="alert alert-warning mb-3" style="border-radius: 12px; border-left: 4px solid #ffc107;">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-lightning-fill me-2" style="font-size: 1.5rem;"></i>
                                <div>
                                    <strong>Super Tie-break</strong>
                                    <small class="d-block text-muted">Cada pareja gan√≥ un set</small>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex gap-3 align-items-center mb-3">
                            <input type="number" class="form-control form-control-lg text-center fw-bold" 
                                   id="tiebreakP1" min="0"
                                   placeholder="0"
                                   style="font-size: 2rem; height: 70px; border-radius: 12px; border: 2px solid #ffc107;">
                            <div class="text-warning fw-bold" style="font-size: 1.5rem;">-</div>
                            <input type="number" class="form-control form-control-lg text-center fw-bold" 
                                   id="tiebreakP2" min="0"
                                   placeholder="0"
                                   style="font-size: 2rem; height: 70px; border-radius: 12px; border: 2px solid #ffc107;">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer" style="padding: 1.25rem 2rem; background: #f8f9fa;">
                <button type="button" class="btn btn-light" data-bs-dismiss="modal" style="border-radius: 10px; padding: 0.625rem 1.5rem;">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" onclick="guardarResultadoFinal()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 10px; padding: 0.625rem 1.5rem; font-weight: 600;">
                    <i class="bi bi-check-circle me-1"></i> Guardar Resultado
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999"></div>
{% endblock %}

{% block extra_js %}
<script>
let currentCategoria = '4ta';
let fixtures = {};

// Cargar fixtures al inicio
document.addEventListener('DOMContentLoaded', function() {
    cargarFixtures();
    
    // Auto-actualizar cada 60 segundos (sin saturar el servidor free-tier)
    setInterval(() => {
        cargarFixtures(/* silencioso= */true);
    }, 60000);
});

// Cargar todos los fixtures
// silencioso=true ‚Üí no muestra errores de red al usuario (para auto-refresh)
async function cargarFixtures(silencioso = false) {
    try {
        const response = await fetch('/api/finales/fixtures', {
            credentials: 'same-origin'
        });

        // El servidor puede devolver HTML (ej: Render despertando) en vez de JSON
        const contentType = response.headers.get('content-type') || '';
        if (!contentType.includes('application/json')) {
            if (!silencioso) showToast('El servidor est√° iniciando, intent√° de nuevo en unos segundos', 'warning');
            return;
        }

        if (response.status === 401) {
            // Sesi√≥n expirada ‚Üí redirigir al login
            window.location.href = '/login';
            return;
        }

        const data = await response.json();
        
        if (data.success) {
            // Mapear nombres de categor√≠as del backend al frontend
            fixtures = {};
            if (data.fixtures['Cuarta']) fixtures['4ta'] = data.fixtures['Cuarta'];
            if (data.fixtures['Quinta']) fixtures['5ta'] = data.fixtures['Quinta'];
            if (data.fixtures['Sexta']) fixtures['6ta'] = data.fixtures['Sexta'];
            if (data.fixtures['S√©ptima']) fixtures['7ma'] = data.fixtures['S√©ptima'];
            
            // Si no hay mapeo, usar los datos tal cual (por si ya vienen con el nombre correcto)
            if (Object.keys(fixtures).length === 0) {
                fixtures = data.fixtures;
            }
            
            actualizarDetallesCategorias();
            cambiarCategoria(currentCategoria || '4ta'); // Mantener categor√≠a actual o mostrar 4ta
        }
    } catch (error) {
        if (!silencioso) console.error('Error al cargar fixtures:', error);
    }
}

// Actualizar detalles de categor√≠as (fases disponibles)
function actualizarDetallesCategorias() {
    const categorias = ['4ta', '5ta', '6ta', '7ma'];
    
    categorias.forEach(cat => {
        const fixture = fixtures[cat];
        let fases = [];
        
        if (fixture) {
            if (fixture.octavos && fixture.octavos.length > 0) fases.push('Octavos');
            if (fixture.cuartos && fixture.cuartos.length > 0) fases.push('Cuartos');
            if (fixture.semifinales && fixture.semifinales.length > 0) fases.push('Semis');
            if (fixture.final) fases.push('Final');
        }
        
        const fasesText = fases.length > 0 ? fases.join(' ‚Ä¢ ') : 'Sin fases';
        document.getElementById(`fases-${cat}`).textContent = fasesText;
    });
}

// Cambiar categor√≠a
function cambiarCategoria(categoria, event = null) {
    currentCategoria = categoria;
    
    // Actualizar botones activos
    document.querySelectorAll('.categoria-btn').forEach(btn => btn.classList.remove('active'));
    
    if (event && event.target) {
        event.target.closest('.categoria-btn').classList.add('active');
    } else {
        // Si no hay evento (llamada program√°tica), activar el bot√≥n correspondiente
        const button = Array.from(document.querySelectorAll('.categoria-btn')).find(
            btn => btn.textContent.includes(categoria)
        );
        if (button) button.classList.add('active');
    }
    
    // Renderizar fixture
    renderizarFixture(categoria);
}

// Renderizar fixture estilo ITF (horizontal)
function renderizarFixture(categoria) {
    const container = document.getElementById('drawContainer');
    const fixture = fixtures[categoria];
    
    // Si no existe el fixture en absoluto, crear estructura vac√≠a
    if (!fixture) {
        container.innerHTML = crearPartidosVacios(categoria);
        return;
    }
    
    let hasAnyRound = false;
    let columns = [];
    
    // Octavos (si hay m√°s de 4 grupos)
    if (fixture.octavos && fixture.octavos.length > 0) {
        hasAnyRound = true;
        columns.push(renderizarColumnaITF('Octavos de Final', fixture.octavos, categoria, true));
    }
    
    // Cuartos (siempre mostrar como m√≠nimo)
    if (fixture.cuartos && fixture.cuartos.length > 0) {
        hasAnyRound = true;
        columns.push(renderizarColumnaITF('Cuartos de Final', fixture.cuartos, categoria, true));
    }
    
    // Semifinales
    if (fixture.semifinales && fixture.semifinales.length > 0) {
        hasAnyRound = true;
        columns.push(renderizarColumnaITF('Semifinales', fixture.semifinales, categoria, true));
    }
    
    // Final
    if (fixture.final) {
        hasAnyRound = true;
        columns.push(renderizarColumnaITF('Final', [fixture.final], categoria, false));
    }
    
    // Si no hay ninguna ronda configurada, mostrar llaves vac√≠as (m√≠nimo cuartos)
    if (!hasAnyRound) {
        container.innerHTML = crearPartidosVacios(categoria);
    } else {
        container.innerHTML = `<div class="draw-grid">${columns.join('')}</div>`;
        
        // Dibujar l√≠neas conectoras despu√©s de renderizar
        setTimeout(() => dibujarLineasConectoras(), 100);
    }
}

// Crear estructura de partidos vac√≠os estilo ITF (m√≠nimo cuartos)
function crearPartidosVacios(categoria) {
    // Por defecto mostramos cuartos, semifinal y final (m√≠nimo)
    const html = `
        <div class="draw-grid">
            <!-- Cuartos -->
            <div class="round-column">
                <div class="round-header-itf">
                    Cuartos de Final
                    <div class="position-badges">
                        <small style="opacity: 0.85; font-size: 0.7rem;">
                            Perdedores: 5¬∞ - 8¬∞ Lugar
                        </small>
                    </div>
                </div>
                <div class="matches-column">
                    ${renderizarPartidoVacioITF()}
                    ${renderizarPartidoVacioITF()}
                    ${renderizarPartidoVacioITF()}
                    ${renderizarPartidoVacioITF()}
                </div>
            </div>
            
            <!-- Semifinales -->
            <div class="round-column">
                <div class="round-header-itf">
                    Semifinales
                    <div class="position-badges">
                        <small style="opacity: 0.85; font-size: 0.7rem;">
                            Perdedores: 3¬∞ - 4¬∞ Lugar
                        </small>
                    </div>
                </div>
                <div class="matches-column">
                    ${renderizarPartidoVacioITF()}
                    ${renderizarPartidoVacioITF()}
                </div>
            </div>
            
            <!-- Final -->
            <div class="round-column">
                <div class="round-header-itf">
                    Final
                    <div class="position-badges">
                        <span class="badge bg-warning text-dark">ü•á 1¬∞ Lugar</span>
                        <span class="badge bg-secondary">ü•à 2¬∞ Lugar</span>
                    </div>
                </div>
                <div class="matches-column">
                    ${renderizarPartidoVacioITF()}
                </div>
            </div>
        </div>
    `;
    
    // Dibujar l√≠neas despu√©s de un momento
    setTimeout(() => dibujarLineasConectoras(), 100);
    
    return html;
}

// Renderizar un partido vac√≠o estilo ITF
function renderizarPartidoVacioITF() {
    return `
        <div class="match-wrapper">
            <div class="match-card-itf" style="cursor: default;">
                <div class="player-row-itf por-definir">
                    <span class="player-name-itf">‚Äî Por definir ‚Äî</span>
                    <span></span>
                    <div class="player-scores"></div>
                </div>
                <div class="player-row-itf por-definir">
                    <span class="player-name-itf">‚Äî Por definir ‚Äî</span>
                    <span></span>
                    <div class="player-scores"></div>
                </div>
            </div>
        </div>
    `;
}

// Renderizar una ronda completa
// Renderizar columna ITF (una ronda con sus partidos)
function renderizarColumnaITF(titulo, partidos, categoria, tieneSiguienteRonda = false) {
    const hasNextClass = tieneSiguienteRonda ? 'has-next' : '';
    
    // Agregar badges de posici√≥n para diferentes fases
    let headerExtra = '';
    
    if (titulo === 'Cuartos de Final') {
        headerExtra = `
            <div class="position-badges">
                <small style="opacity: 0.85; font-size: 0.7rem;">
                    Perdedores: 5¬∞ - 8¬∞ Lugar
                </small>
            </div>
        `;
    } else if (titulo === 'Semifinales') {
        headerExtra = `
            <div class="position-badges">
                <small style="opacity: 0.9; font-size: 0.7rem;">
                    Perdedores: 3¬∞ - 4¬∞ Lugar
                </small>
            </div>
        `;
    } else if (titulo === 'Final') {
        headerExtra = `
            <div class="position-badges">
                <span class="badge bg-warning text-dark">ü•á 1¬∞ Lugar</span>
                <span class="badge bg-secondary">ü•à 2¬∞ Lugar</span>
            </div>
        `;
    }
    
    let html = `
        <div class="round-column ${hasNextClass}">
            <div class="round-header-itf">
                ${titulo}
                ${headerExtra}
            </div>
            <div class="matches-column">
    `;
    
    partidos.forEach((partido, idx) => {
        html += renderizarPartidoITF(partido, categoria, tieneSiguienteRonda, idx);
    });
    
    html += `
            </div>
        </div>
    `;
    
    return html;
}

// Renderizar un partido individual estilo ITF
function renderizarPartidoITF(partido, categoria, tieneSiguienteRonda = false, idx = 0) {
    // Sets para mostrar (si hay resultado)
    const sets = partido.sets || [];
    const tieneResultado = sets.length > 0;
    
    // Construir el texto para cada pareja
    // Si hay resultado: mostrar solo el nombre (los sets se muestran en la columna de scores)
    // Si NO hay resultado pero hay pareja: mostrar nombre + badge de posici√≥n
    // Si no hay pareja: mostrar solo slot_info o texto por defecto
    let pareja1Text = '';
    let pareja2Text = '';
    
    if (partido.pareja1) {
        // Si tiene resultado, mostrar solo el nombre
        if (tieneResultado) {
            pareja1Text = `<span class="player-name-itf">${partido.pareja1.nombre}</span>`;
        } else {
            // Si NO tiene resultado pero tiene slot_info, mostrar nombre + badge de posici√≥n
            if (partido.slot1_info && partido.slot1_info !== 'Vac√≠o') {
                pareja1Text = `<span class="player-name-itf">${partido.pareja1.nombre}</span><small style="display: block; opacity: 0.7; font-size: 0.7rem; margin-top: 2px;">${partido.slot1_info}</small>`;
            } else {
                pareja1Text = `<span class="player-name-itf">${partido.pareja1.nombre}</span>`;
            }
        }
    } else {
        pareja1Text = partido.slot1_info || '‚Äî Por definir ‚Äî';
    }
    
    if (partido.pareja2) {
        // Si tiene resultado, mostrar solo el nombre
        if (tieneResultado) {
            pareja2Text = `<span class="player-name-itf">${partido.pareja2.nombre}</span>`;
        } else {
            // Si NO tiene resultado pero tiene slot_info, mostrar nombre + badge de posici√≥n
            if (partido.slot2_info && partido.slot2_info !== 'Vac√≠o') {
                pareja2Text = `<span class="player-name-itf">${partido.pareja2.nombre}</span><small style="display: block; opacity: 0.7; font-size: 0.7rem; margin-top: 2px;">${partido.slot2_info}</small>`;
            } else {
                pareja2Text = `<span class="player-name-itf">${partido.pareja2.nombre}</span>`;
            }
        }
    } else {
        pareja2Text = partido.slot2_info || '‚Äî Por definir ‚Äî';
    }
    
    const ganador = partido.ganador ? partido.ganador.id : null;
    
    const pareja1Id = partido.pareja1 ? partido.pareja1.id : null;
    const pareja2Id = partido.pareja2 ? partido.pareja2.id : null;
    
    const pareja1Class = ganador === pareja1Id ? 'winner' : '';
    const pareja2Class = ganador === pareja2Id ? 'winner' : '';
    const porDefinir1 = !partido.pareja1 ? 'por-definir' : '';
    const porDefinir2 = !partido.pareja2 ? 'por-definir' : '';
    
    // Generar HTML para sets - mostrar solo el n√∫mero de games de cada pareja en cada set
    let setsHTML1 = '';
    let setsHTML2 = '';
    
    if (tieneResultado) {
        sets.forEach(set => {
            setsHTML1 += `<div class="score-set">${set.pareja1 || '-'}</div>`;
            setsHTML2 += `<div class="score-set">${set.pareja2 || '-'}</div>`;
        });
    }
    
    // Para el click handler, usar nombres simples sin HTML
    const pareja1Nombre = partido.pareja1 ? partido.pareja1.nombre : (partido.slot1_info || 'Por definir');
    const pareja2Nombre = partido.pareja2 ? partido.pareja2.nombre : (partido.slot2_info || 'Por definir');
    
    // Click para abrir modal de resultado (solo si ambas parejas est√°n definidas y no hay ganador)
    const clickHandler = partido.pareja1 && partido.pareja2 && !ganador 
        ? `onclick="abrirModalResultadoFinal('${partido.id}', '${categoria}', '${pareja1Nombre}', '${pareja2Nombre}')"` 
        : '';
    
    const cursorStyle = partido.pareja1 && partido.pareja2 && !ganador ? 'cursor: pointer;' : 'cursor: default;';
    
    return `
        <div class="match-wrapper">
            <div class="match-card-itf" ${clickHandler} style="${cursorStyle}">
                <div class="player-row-itf ${pareja1Class} ${porDefinir1}">
                    ${pareja1Text}
                    ${(partido.pareja1 && ganador === pareja1Id) ? '<i class="bi bi-check-circle-fill player-check"></i>' : ''}
                    <div class="player-scores">
                        ${setsHTML1}
                    </div>
                </div>
                <div class="player-row-itf ${pareja2Class} ${porDefinir2}">
                    ${pareja2Text}
                    ${(partido.pareja2 && ganador === pareja2Id) ? '<i class="bi bi-check-circle-fill player-check"></i>' : ''}
                    <div class="player-scores">
                        ${setsHTML2}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// ========== FUNCI√ìN PARA DIBUJAR L√çNEAS CONECTORAS CON SVG ==========
function dibujarLineasConectoras() {
    const drawGrid = document.querySelector('.draw-grid');
    if (!drawGrid) return;
    
    // Eliminar SVG anterior si existe
    const existingSvg = drawGrid.querySelector('.bracket-connections');
    if (existingSvg) existingSvg.remove();
    
    // Crear contenedor SVG
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute('class', 'bracket-connections');
    svg.style.position = 'absolute';
    svg.style.top = '0';
    svg.style.left = '0';
    svg.style.width = '100%';
    svg.style.height = '100%';
    svg.style.pointerEvents = 'none';
    svg.style.zIndex = '0';
    
    const columns = Array.from(drawGrid.querySelectorAll('.round-column'));
    
    // Conectar cada columna con la siguiente
    for (let i = 0; i < columns.length - 1; i++) {
        const currentColumn = columns[i];
        const nextColumn = columns[i + 1];
        
        const currentMatches = Array.from(currentColumn.querySelectorAll('.match-wrapper'));
        const nextMatches = Array.from(nextColumn.querySelectorAll('.match-wrapper'));
        
        // Conectar pares de partidos actuales con el siguiente
        for (let j = 0; j < nextMatches.length; j++) {
            const match1 = currentMatches[j * 2];
            const match2 = currentMatches[j * 2 + 1];
            const nextMatch = nextMatches[j];
            
            if (match1 && match2 && nextMatch) {
                dibujarConexionBracket(svg, match1, match2, nextMatch, drawGrid);
            }
        }
    }
    
    drawGrid.appendChild(svg);
}

function dibujarConexionBracket(svg, match1, match2, nextMatch, container) {
    const svgNS = "http://www.w3.org/2000/svg";
    
    // Obtener posiciones relativas al contenedor
    const containerRect = container.getBoundingClientRect();
    const rect1 = match1.getBoundingClientRect();
    const rect2 = match2.getBoundingClientRect();
    const rectNext = nextMatch.getBoundingClientRect();
    
    // Punto de salida del medio derecho de cada partido
    const x1 = rect1.right - containerRect.left;
    const y1 = rect1.top + rect1.height / 2 - containerRect.top;
    
    const x2 = rect2.right - containerRect.left;
    const y2 = rect2.top + rect2.height / 2 - containerRect.top;
    
    // Punto de llegada en el medio izquierdo del siguiente partido
    const xNext = rectNext.left - containerRect.left;
    const yNext = rectNext.top + rectNext.height / 2 - containerRect.top;
    
    // Punto medio horizontal donde se unen las l√≠neas verticales
    const xMid = x1 + (xNext - x1) / 2;
    
    // Crear path con forma de bracket
    const path = document.createElementNS(svgNS, "path");
    
    // Dibujar: horizontal desde match1, vertical hasta el medio, vertical desde match2, horizontal hasta medio, horizontal al siguiente
    const pathData = `
        M ${x1} ${y1}
        L ${xMid} ${y1}
        L ${xMid} ${yNext}
        M ${x2} ${y2}
        L ${xMid} ${y2}
        L ${xMid} ${yNext}
        M ${xMid} ${yNext}
        L ${xNext} ${yNext}
    `;
    
    path.setAttribute('d', pathData.trim());
    path.setAttribute('class', 'bracket-line');
    
    svg.appendChild(path);
}

// Redibujar l√≠neas cuando cambia el tama√±o de ventana
window.addEventListener('resize', () => {
    if (document.querySelector('.draw-grid')) {
        dibujarLineasConectoras();
    }
});

// Limitar valores de inputs de games (m√°ximo 6 para sets normales)
function limitarGamesInput(input, maxValue = 6) {
    let value = parseInt(input.value);
    if (isNaN(value) || value < 0) {
        input.value = '';
    } else if (value > maxValue) {
        input.value = maxValue;
    }
}

// Verificar si se necesita tie-break basado en los sets actuales
function verificarNecesidadTiebreak() {
    const set1P1 = parseInt(document.getElementById('gamesSet1P1').value) || 0;
    const set1P2 = parseInt(document.getElementById('gamesSet1P2').value) || 0;
    const set2P1 = parseInt(document.getElementById('gamesSet2P1').value) || 0;
    const set2P2 = parseInt(document.getElementById('gamesSet2P2').value) || 0;
    
    // Si no hay sets completos, no mostrar tie-break
    if (set1P1 === 0 && set1P2 === 0 && set2P1 === 0 && set2P2 === 0) {
        document.getElementById('tiebreakCardFinal').style.display = 'none';
        return;
    }
    
    // Contar sets ganados
    const setsP1 = (set1P1 > set1P2 ? 1 : 0) + (set2P1 > set2P2 ? 1 : 0);
    const setsP2 = (set1P2 > set1P1 ? 1 : 0) + (set2P2 > set2P1 ? 1 : 0);
    
    // Mostrar tie-break solo si est√°n 1-1 en sets
    if (setsP1 === 1 && setsP2 === 1) {
        document.getElementById('tiebreakCardFinal').style.display = 'block';
    } else {
        document.getElementById('tiebreakCardFinal').style.display = 'none';
    }
}

// Abrir modal para ingresar resultado de final
function abrirModalResultadoFinal(partidoId, categoria, pareja1Nombre, pareja2Nombre) {
    // Guardar datos en el modal
    document.getElementById('resultadoPartidoId').value = partidoId;
    document.getElementById('resultadoCategoria').value = categoria;
    document.getElementById('resultadoFinalPareja1').textContent = pareja1Nombre;
    document.getElementById('resultadoFinalPareja2').textContent = pareja2Nombre;
    
    // Limpiar sets
    document.getElementById('gamesSet1P1').value = '';
    document.getElementById('gamesSet1P2').value = '';
    document.getElementById('gamesSet2P1').value = '';
    document.getElementById('gamesSet2P2').value = '';
    document.getElementById('tiebreakP1').value = '';
    document.getElementById('tiebreakP2').value = '';
    
    // Ocultar tiebreak inicialmente
    document.getElementById('tiebreakCardFinal').style.display = 'none';
    
    // Agregar listeners para detectar autom√°ticamente cuando se necesita tie-break
    // Y para limitar los valores de los sets normales a m√°ximo 6
    const setInputs = ['gamesSet1P1', 'gamesSet1P2', 'gamesSet2P1', 'gamesSet2P2'];
    setInputs.forEach(inputId => {
        const input = document.getElementById(inputId);
        // Remover listeners anteriores si existen
        input.removeEventListener('input', verificarNecesidadTiebreak);
        input.removeEventListener('change', verificarNecesidadTiebreak);
        // Agregar nuevos listeners
        input.addEventListener('input', () => {
            limitarGamesInput(input, 6);
            verificarNecesidadTiebreak();
        });
        input.addEventListener('change', () => {
            limitarGamesInput(input, 6);
            verificarNecesidadTiebreak();
        });
        input.addEventListener('blur', () => {
            limitarGamesInput(input, 6);
        });
    });
    
    // Abrir modal
    const modal = new bootstrap.Modal(document.getElementById('modalResultadoFinal'));
    modal.show();
}

// Guardar resultado de final
async function guardarResultadoFinal() {
    const partidoId = document.getElementById('resultadoPartidoId').value;
    const categoria = document.getElementById('resultadoCategoria').value;
    
    const set1P1 = parseInt(document.getElementById('gamesSet1P1').value) || 0;
    const set1P2 = parseInt(document.getElementById('gamesSet1P2').value) || 0;
    const set2P1 = parseInt(document.getElementById('gamesSet2P1').value) || 0;
    const set2P2 = parseInt(document.getElementById('gamesSet2P2').value) || 0;
    
    // Validar que hay sets ingresados
    if (set1P1 === 0 && set1P2 === 0 && set2P1 === 0 && set2P2 === 0) {
        showToast('Debes ingresar al menos los resultados de 2 sets', 'warning');
        return;
    }
    
    // Validar que los games no excedan 6 en sets normales
    if (set1P1 > 6 || set1P2 > 6 || set2P1 > 6 || set2P2 > 6) {
        showToast('Los games en un set no pueden ser mayores a 6', 'warning');
        return;
    }
    
    const sets = [
        { pareja1: set1P1, pareja2: set1P2 },
        { pareja1: set2P1, pareja2: set2P2 }
    ];
    
    // Verificar si hay tiebreak (1-1 en sets)
    const setsP1 = (set1P1 > set1P2 ? 1 : 0) + (set2P1 > set2P2 ? 1 : 0);
    const setsP2 = (set1P2 > set1P1 ? 1 : 0) + (set2P2 > set2P1 ? 1 : 0);
    
    if (setsP1 === 1 && setsP2 === 1) {
        // Requiere super tiebreak
        const tieP1 = parseInt(document.getElementById('tiebreakP1').value) || 0;
        const tieP2 = parseInt(document.getElementById('tiebreakP2').value) || 0;
        
        if (tieP1 === 0 && tieP2 === 0) {
            showToast('Debes ingresar el resultado del super tie-break', 'warning');
            document.getElementById('tiebreakCardFinal').style.display = 'block';
            return;
        }
        
        sets.push({ pareja1: tieP1, pareja2: tieP2 });
    }
    
    try {
        const response = await fetch(`/api/finales/partido/${partidoId}/resultado`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sets: sets })
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Resultado guardado correctamente', 'success');
            bootstrap.Modal.getInstance(document.getElementById('modalResultadoFinal')).hide();
            await cargarFixtures(); // Recargar fixtures
        } else {
            showToast('Error al guardar resultado: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'danger');
    }
}

// Regenerar fixtures
async function regenerarFixtures() {
    if (!confirm('¬øEst√°s seguro de regenerar las llaves? Esto actualizar√° las parejas clasificadas bas√°ndose en las posiciones actuales de los grupos.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/finales/fixtures/regenerar', {
            method: 'POST'
        });
        
        const data = await response.json();
        
        if (data.success) {
            showToast('Llaves regeneradas correctamente', 'success');
            await cargarFixtures();
        } else {
            showToast('Error al regenerar: ' + data.message, 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error de conexi√≥n', 'danger');
    }
}

// Cargar calendario
async function cargarCalendario() {
    const container = document.getElementById('calendarioContainer');
    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
    
    try {
        const response = await fetch('/api/finales/calendario');
        const data = await response.json();
        
        if (data.success) {
            renderizarCalendario(data.calendario);
        } else {
            container.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
        }
    } catch (error) {
        console.error('Error:', error);
        container.innerHTML = '<div class="alert alert-danger">Error al cargar el calendario</div>';
    }
}

// Renderizar calendario
function renderizarCalendario(calendario) {
    const container = document.getElementById('calendarioContainer');
    
    // Agrupar por bloques horarios (ma√±ana y tarde)
    const cancha1 = calendario.cancha_1 || [];
    const cancha2 = calendario.cancha_2 || [];
    
    // Si no hay partidos, mostrar mensaje
    if (cancha1.length === 0 && cancha2.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">üìÖ</div>
                <p class="empty-state-text">El calendario se generar√° autom√°ticamente</p>
                <p class="text-muted mt-2">Una vez que las llaves est√©n definidas</p>
            </div>
        `;
        return;
    }
    
    // Separar en bloques
    const mananaC1 = cancha1.filter(p => parseInt(p.hora_inicio.split(':')[0]) < 15);
    const tardeC1 = cancha1.filter(p => parseInt(p.hora_inicio.split(':')[0]) >= 16);
    const mananaC2 = cancha2.filter(p => parseInt(p.hora_inicio.split(':')[0]) < 15);
    const tardeC2 = cancha2.filter(p => parseInt(p.hora_inicio.split(':')[0]) >= 16);
    
    let html = '';
    
    // Bloque Ma√±ana
    if (mananaC1.length > 0 || mananaC2.length > 0) {
        html += `
            <div class="horario-section">
                <h3 class="horario-title">
                    <i class="bi bi-sunrise"></i>
                    Bloque Ma√±ana
                </h3>
                <div class="canchas-row">
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-1-circle-fill me-2"></i>Cancha 1</div>
                        ${renderizarPartidosCalendario(mananaC1)}
                    </div>
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-2-circle-fill me-2"></i>Cancha 2</div>
                        ${renderizarPartidosCalendario(mananaC2)}
                    </div>
                </div>
            </div>
        `;
    }
    
    // Solo mostrar pausa si hay partidos en ma√±ana Y en tarde
    if ((mananaC1.length > 0 || mananaC2.length > 0) && (tardeC1.length > 0 || tardeC2.length > 0)) {
        html += `
            <div class="pausa-section">
                <div class="pausa-icon">‚è∏Ô∏è</div>
                <p class="pausa-text">PAUSA</p>
                <small class="text-muted">No se juega en ninguna cancha</small>
            </div>
        `;
    }
    
    // Bloque Tarde
    if (tardeC1.length > 0 || tardeC2.length > 0) {
        html += `
            <div class="horario-section">
                <h3 class="horario-title">
                    <i class="bi bi-sunset"></i>
                    Bloque Tarde
                </h3>
                <div class="canchas-row">
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-1-circle-fill me-2"></i>Cancha 1</div>
                        ${renderizarPartidosCalendario(tardeC1)}
                    </div>
                    <div class="cancha-column">
                        <div class="cancha-header"><i class="bi bi-2-circle-fill me-2"></i>Cancha 2</div>
                        ${renderizarPartidosCalendario(tardeC2)}
                    </div>
                </div>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

// Renderizar partidos del calendario
function renderizarPartidosCalendario(partidos) {
    if (partidos.length === 0) {
        return '<p class="text-muted text-center py-3">Sin partidos asignados</p>';
    }
    
    return partidos.map(p => {
        const categoriaClass = `partido-${p.categoria.toLowerCase()}`;
        const pareja1 = p.pareja1 || 'Por definir';
        const pareja2 = p.pareja2 || 'Por definir';
        
        return `
            <div class="partido-calendario ${categoriaClass}">
                <div class="partido-hora">${p.hora_inicio}</div>
                <div class="partido-info">
                    <strong>${p.categoria}</strong> - ${p.fase}
                </div>
                <div class="partido-parejas">
                    ${pareja1} <strong>vs</strong> ${pareja2}
                </div>
            </div>
        `;
    }).join('');
}

// Toast helper
function showToast(message, type = 'info') {
    const toastHtml = `
        <div class="toast align-items-center text-white bg-${type} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    const container = document.querySelector('.toast-container');
    container.insertAdjacentHTML('beforeend', toastHtml);
    
    const toastEl = container.lastElementChild;
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}
</script>
{% endblock %}
